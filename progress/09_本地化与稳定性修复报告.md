# 工作日志：本地化实施与系统稳定性强化

**日期：** 2026-02-10  
**状态：** 已完成  
**执行人：** 莱芙・泽诺 (Lev Zenith)

---

## 1. 任务概述
本次工作主要完成了播放器从硬编码字符串向 .NET 资源文件 (.resx) 体系的迁移，实现了中英双语切换，并修复了导致程序启动崩溃的严重逻辑缺陷，提升了全局异常防护能力。

## 2. 变更详情

### 2.1 本地化架构实施
- **资源文件构建**：建立了 `Properties/Resources.resx` (默认/EN) 与 `Properties/Resources.zh-CN.resx` (中文) 体系。
- **UI 逻辑重构**：
    - 移除了散落在 XAML 与 C# 代码中的硬编码中文字符串。
    - 实现了 `ApplyLanguage()` 方法，通过程序逻辑在运行时根据 `Properties.Resources.Culture` 统一更新 UI 组件。
- **语言切换引擎**：
    - 修改 `btnSwitchLang_Click` 处理程序，支持设置持久化保存。
    - 引入了**自动重启机制**：用户确认后，程序通过 `Process.Start` 启动新实例并安全关闭旧实例，确保资源完全重载。

### 2.2 稳定性修复与系统强化
- **初始化序列优化**：
    - **现象**：程序启动时偶发性 `NullReferenceException` 闪退。
    - **病因**：`UpdateButtons` 方法在 `MainWindow` 构造函数中先于 `_tmrUpdate` (定时器实例) 被调用，导致对空对象的引用。
    - **修复**：重新排列构造函数内的初始化顺序，确保所有后台服务实例在 UI 刷新前已完成实例化。
- **全局异常防御**：
    - 在 `App.xaml.cs` 中注入 `DispatcherUnhandledException` 与 `AppDomain.UnhandledException` 监听器。
    - 确保任何未捕获的严重错误都能通过详细的对话框反馈给用户，而非无响应闪退。

### 2.3 编译与构建优化
- 解决了由于背景进程残留导致的 `MSB3021` (文件被占用) 构建错误。
- 优化了项目构建流程，确保生成的 `.exe` 文件在 `net48` 环境下具备完整的资源依赖。

### 2.4 本地化遗留问题与约束
- **手动搬运模式**：当前仍依赖 `ApplyLanguage()` 方法手动指派 UI 文本，尚未实现完全自动化的 XAML 资源绑定。
- **词条不完整**：部分动态状态（如“暂停/播放”切换、工具提示等）在 `ApplyLanguage()` 中仍采用临时 `isZh` 逻辑，未完全录入 `.resx` 字典。
- **XAML 冗余**：XAML 中的 `Text` 属性保留了初始硬编码值作为回退，未升级到声明式静态引用。

## 3. 待办事项 (Next Steps)
- [ ] **完整词条字典化**：将所有残留的 `isZh` 判断逻辑替换为完整的 `.resx` 资源项。
- [ ] **UI 自动绑定升级**：待系统完全稳定后，将 `ApplyLanguage()` 手动赋值模式升级为 XAML `{x:Static}` 静态绑定，实现真正的 UI/逻辑分离。
- [x] **SQLite 数据迁移**：按照 `07_SQLite迁移与别名系统方案.md` 进行数据库迁移。(已在 11_SQLite数据库迁移与架构升级报告 中完成)
- [ ] **歌单性能监控**：优化大量文件场景下的加载体验。

---
**日志记录完毕。** (￣^￣)ゞ
