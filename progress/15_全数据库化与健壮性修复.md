# 15. 全数据库化与健壮性修复报告

**日期**: 2026-02-11  
**负责人**: 莱芙 (Lev Zenith)  
**版本**: v3.3 (Pre-Release) 

---

## 📅 工作概述

本次更新标志着项目彻底摆脱了基于文本文件 (`playlists.conf`) 的歌单管理方式，全面转向 SQLite 数据库驱动的“虚拟歌单系统”。同时，修复了因数据库设计缺陷导致的“文件路径丢失”问题，大幅提升了系统的健壮性和数据完整性。

---

## 🚀 核心变更

### 1. 废弃 `playlists.conf` (全数据库化)
- **旧机制**: 依赖本地 `playlists.conf` 文本文件记录歌单名和路径。
- **新机制**: 
    - 使用数据库 `Playlists` 表存储歌单元数据。
    - 使用 `PlaylistItems` 表关联歌单与曲目 ID。
    - **收益**: 支持更复杂的查询、重命名、删除操作，且数据一致性得到数据库事务保障。

### 2. 数据库结构升级 (Schema Evolution)
- **新增字段**: `LoopPoints` 表新增 `FilePath` 字段。
- **原因**: 之前仅依赖 `FileName` + `TotalSamples` (指纹) 识别歌曲，导致无法反向恢复物理文件路径，UI 显示为 `[Missing]`。
- **自动迁移**: 实现了数据库自动检测并 `ALTER TABLE` 添加字段的逻辑，旧数据可无缝升级。

### 3. 健壮性增强 (Robustness)
- **路径记忆**: 在扫描文件夹时，强制检查并在数据库中更新现有指纹对应的 `FilePath`，确保“搬家”后的文件也能被正确追踪。
- **存活性检测**: 
    - 在加载歌单时，实时检测物理文件是否存在 (`File.Exists`)。
    - 丢失文件在 UI 上红字标注 `[Missing]` / `[文件丢失]`，并给出汇总统计。
- **启动恢复**: 优化了 `MainWindow` 启动时的“最后一次歌单”加载逻辑，支持 ID 与路径的双重降级匹配。

### 4. UI/UX 交互优化
- **右键菜单修正**: 
    - 修复了歌单右键“Add Folder”误触发“新建歌单”的问题。
    - 现在的逻辑明确为：向**当前选中**的歌单**追加**文件夹内的曲目。
- **编译修复**: 
    - 彻底移除了 `dynamic` 关键字的使用，消除了对 `Microsoft.CSharp` 的依赖报错。
    - 清理了 `MainWindow.xaml.cs` 中残留的冗余类定义。

---

## 🛠️ 技术细节

### PlayerService 重构
```csharp
// 扫描文件夹时的防覆盖与路径更新逻辑
public async Task ScanAndAddFolderToPlaylist(...) {
    // ...
    if (track == null) {
        // 新歌：创建并保存
    } else {
        // 老歌：更新物理路径并强制回写数据库！
        track.FilePath = f;
        _dbHelper.SaveTrack(track);
    }
    // ...
}
```

### DatabaseHelper 升级
- **查询优化**: 所有 SQL 查询均显式包含 `FilePath` 字段，确保 Dapper 映射完整。
- **去动态化**: 使用 `IDataReader` 替代 `dynamic` 进行元数据查询，提高兼容性。

---

## 📝 遗留问题与下一步计划

- [ ] **歌单拖拽排序**: 目前 `PlaylistItems` 表虽然有 `SortOrder` 字段，但 UI 尚未支持拖拽排序。
- [ ] **丢失文件处理**: 目前仅显示 `[Missing]`，没有提供“定位文件”或“移除所有丢失项”的快捷操作。
- [ ] **多选操作**: 歌单列表和歌曲列表目前仅支持单选操作。

---

*“为了不再让大人看到满屏的 [Missing]，莱芙可是把数据库的家底都翻了一遍呢！” —— Lev Zenith*
