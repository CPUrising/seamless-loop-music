# 工作日志：SQLite 数据库迁移与系统架构升级报告

**日期：** 2026-02-10
**状态：** 已完成 (核心功能) / 进行中 (UI 别名交互)
**执行人：** 莱芙・泽诺 (Lev Zenith)

---

## 1. 任务概述

本次工作实现了从传统 CSV 文本存储向 SQLite 工业级数据库的全面迁移，并同步完成了项目代码的模块化重构。核心目标是建立一个稳定、可移植且具备“指纹识别”能力的歌曲配置管理系统。

## 2. 变更详情

### 2.1 项目架构重构 (Architecture Layering)

- **物理分层**：将混杂在根目录的源代码按功能划分为四个核心模块：
  - `Core/`：音频处理引擎（`AudioLooper`, `LoopStream`）。
  - `UI/`：界面展示与交互逻辑（`MainWindow`, `FolderPicker`）。
  - `Models/`：数据实体定义（`MusicTrack`）。
  - `Data/`：持久化存储层（`DatabaseHelper`）。
- **逻辑优化**：通过命名空间重组，实现了 UI 层与业务逻辑层的初步解耦。

### 2.2 SQLite 数据库体系建设

- **依赖集成**：引入了 `System.Data.SQLite.Core` 以及轻量级 ORM 框架 `Dapper`。
- **自愈式初始化**：实现了 `DatabaseHelper` 自动创建 `LoopData.db` 及表结构的功能。
- **指纹识别逻辑 (Fingerprint Matching)**：
  - **改进前**：依赖脆弱的物理路径。
  - **改进后**：使用 `(FileName, TotalSamples)` 的组合作为唯一标识符。
  - **收益**：彻底解决了文件移动或程序目录变更导致的配置丢失问题，实现了“只要文件名不改，配置永不丢失”。

### 2.3 数据自动化迁移

- **迁移引擎**：实现了 `MigrateCsvToSqlite` 逻辑。
- **过程**：程序启动时自动检测旧版 `loop_config.csv`，读取数据并批量注入新数据库。
- **安全性**：搬家完成后，自动将旧文件更名为 `.csv.bak` 进行物理隔离，确保数据安全。

### 2.4 冗余清理与稳定性优化

- **清理**：删除了 `LoopConfigItem` 类及内存字典 `_loopConfigs`，所有配置读写直连数据库。
- **修复**：更新了 `App.xaml` 的启动路径，解决了重构后的启动映射问题。
- **内存防护**：确认了歌曲配置在内存中的极低占用率，彻底排除内存溢出风险。

## 3. 遗留与后续规划 (Upcoming)

- [X] **别名交互系统**：实现在歌曲列表右键点击进行“修改别名”的功能。
- [X] **UI 联动映射**：在播放列表中优先显示数据库中的 `DisplayName`。

---

**日志记录完毕。** (￣^￣)ゞ
