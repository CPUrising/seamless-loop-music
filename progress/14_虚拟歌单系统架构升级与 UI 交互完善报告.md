# 工作日志：虚拟歌单架构升级与 UI 交互完善报告

**日期：** 2026-02-11
**状态：** 核心架构已完成，功能测试通过
**执行人：** 莱芙 (Lev Zenith)

---

## 1. 任务背景
在完成基础播放模式后，为了解决大规模曲目管理、多歌单引用以及曲目身份识别等问题，对项目进行了从“物理路径驱动”到“数据库虚拟引用”的底层逻辑架构升级。

## 2. 完成功能详情

### 2.1 数据库架构 (Database Schema)
- **多表联动**：在 `LoopData.db` 中建立了 `Playlists` (歌单) 和 `PlaylistItems` (歌单项) 表，支持“歌单-歌曲”的逻辑引用。
- **外键约束**：开启了 SQLite `PRAGMA foreign_keys = ON`，确保歌单与关联项的删除动作具备一致性。

### 2.2 歌曲库与智能预扫描 (Song Library & Scanning)
- **指纹背景录入**：导入文件夹时，系统自动开启后台任务 (`Task.Run`) 计算每首音频的采样总数（指纹），并预先登记入库。
- **身份脱钩**：由于建立了基于采样数和文件名的识别机制，曲目的别名(Alias)与手动循环点配置在文件移动或多歌单引用下均能保持唯一性和准确性。

### 2.3 UI 交互与性能优化 (UI/UX)
- **UI 虚拟化与同步**：
    - 将 `_playlists` 修改为 `ObservableCollection`，实现了歌单列表的平滑自动刷新。
    - 为 `MusicTrack` 模型实现了 `INotifyPropertyChanged`，确保后台扫描出的采样信息（ID/别名）能实时呈现在 UI 列表上，无需重启。
- **右键菜单扩展**：
    - 侧边栏：新增“右键添加文件夹”，并支持循环扫入（连续询问模式）。
    - 歌曲列表：新增“打开所在文件夹”以及“从歌单移除”功能。
- **缺陷修复**：
    - 修正了 `DisplayMemberPath` 与 `DataTemplate` 在 WPF 中的冲突崩溃。
    - 将 `PlaylistFolder` 类设为 `public`，解决了 WPF 数据绑定不可见的问题。
    - 清理了切换歌单时导致选中项失效的同步重置逻辑。

## 3. 性能预期
- **大规模数据支持 (1000+ 首)**：方案确认采用 WPF 定位虚拟化渲染技术 + 异步 DB 读取。预计 5000 条曲目量级的加载耗时控制在 100ms 以内，UI 操作不产生阻塞。

## 4. 下一步计划
- **彻底切换为虚拟逻辑**：实现不依赖物理文件夹的“纯虚拟歌单”创建与拖拽管理。
- **进度持久化**：将当前选中的模式、循环限制次数保存至数据库。

---
工作日志记录完毕。
