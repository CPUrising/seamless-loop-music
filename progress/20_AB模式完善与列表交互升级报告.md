# A/B 模式完善与列表交互升级报告

**日期**: 2026-02-12
**版本**: v1.4.0

## 1. A/B 模式核心逻辑完善

### 1.1 背景
之前的 A/B 模式虽然实现了物理合体播放，但在自动匹配算法调用和用户手动干预后的恢复能力上略有欠缺。本次更新重点强化了该模式的“可演进性”与“可逆性”。

### 1.2 关键改进：AB重置与匹配增强
*   **一键恢复接缝 (Restore A/B Boundary)**：
    *   针对用户在智能匹配后可能不满意的场景，系统在 `PlayerService` 中实现了 `ResetABLoopPoints` 逻辑。
    *   该功能通过重新读取 A 段文件的原始物理采样数，精准地将循环起点重置到两文件拼接的原始接缝处，实现了逻辑上的“反悔机制”。
*   **匹配算法兼容性升级**：
    *   升级了 `AudioLooper` 的分析流构建逻辑。现在，即使处于 A/B 拼接模式，后台分析引擎也会在内存中模拟拼接后的完整波形进行特征提取。
    *   确保了“寻找起点/终点”等智能匹配功能在拼接曲目上表现得如同单文件一般流畅、准确。

## 2. UI 列表交互架构升级：从单选到多选、从静态到动态

### 2.1 歌单批量管理系统
*   **多选支持**：解锁了左侧歌单列表的 `Extended` 选中模式。用户现可通过 `Ctrl/Shift` 键批量选中多个歌单执行任务。
*   **批量执行引擎**：
    *   **批量刷新**：允许一次性同步多个关联文件夹。系统采用串行逐个刷新策略，并在状态栏通过 `(1/X)` 计数器实时汇报各文件夹的扫描进度。
    *   **批量删除**：实现了针对逻辑歌单的批量移除功能，并对删除确认逻辑进行了重构，提高了库整理效率。
*   **动态右键菜单 (Smart Menu)**：
    *   重写了菜单开启逻辑，根据当前选中的歌单数量及类型（文件夹关联 vs 虚拟歌单）动态显隐菜单项。例如，“重命名”在多选时会自动隐藏以防冲突。

### 2.2 全局拖拽排序与持久化
*   **拖拽交互实现**：
    *   在歌单列表与歌曲列表同时实现了基于 `PreviewMouseMove` 的拖拽排序机制。
    *   **智能边界滚动 (Auto-Scroll)**：针对长列表拖拽痛点，实现了 DragOver 时的自动滚动逻辑。当鼠标悬停于列表上下边缘时，系统会自动触发 `ScrollViewer` 的行级滚动。
*   **排序权重存储 (SortOrder)**：
    *   在 SQLite 数据库的 `Playlists` 与 `PlaylistItems` 表中均引入了 `SortOrder` 字段。
    *   用户调整后的视觉顺序将实时持久化到数据库中。系统加载歌单时将严谨地遵循 `ORDER BY SortOrder ASC` 逻辑。

## 3. 体验细节优化

### 3.1 界面智能感知
*   **按需点亮**：全新的【恢复AB接缝】按钮支持实时状态感应。仅当当前播放音轨为 A/B 合体模式时，按钮才会变为可点击状态（高亮红色），否则保持灰色禁用。
*   **语言支持补完**：在 `ApplyLanguage` 逻辑中完善了所有新增按钮、右键菜单项及批量确认弹窗的中英双语资源。

## 4. 结论
本次更新标志着软件从“单一曲目管理”向“高效资源库管理”的转变。通过引入拖拽重排与批量操作，极大地提升了用户构建大规模无缝曲库的效率。同时，对 A/B 模式接缝逻辑的严密补全，确保了在复杂应用场景下的最高容错率。
