# 双向智能匹配与挂机稳定性修复报告

**日期**: 2026-02-12
**版本**: v1.2.0

## 1. 核心功能升级：双向智能循环匹配

### 1.1 背景
为了更好地支持原声带 (OST) 等具有 [Intro + Loop Body + Tail] 结构的音频文件，单一的“逆向匹配”算法（固定结尾找开头）无法满足需求。因此引入了“正向匹配”算法。

### 1.2 实现方案
在 `AudioLooper` 类中重构 `FindBestLoopPointsAsync` 方法，引入 `adjustStart` 参数：
*   **寻找起点 (Match Start / Reverse)**:
    *   逻辑：保持现有算法。固定 Loop End，取其前置波形为样本，在 Start 附近搜索相似片段。
    *   用途：适用于常规循环微调。
*   **寻找终点 (Match End / Forward)**:
    *   逻辑：新增算法。固定 Loop Start，取其后置波形为样本，在 End 附近搜索相似片段。
    *   用途：专用于 OST 结构，通过头部特征定位尾部循环点。
    *   **边界处理**: 修复了当 Start 位于文件头部极短位置（如 <1s）时，动态调整采样窗口大小以避免算法失效的问题。

### 1.3 UI 交互更新
*   主界面新增“寻找终点”按钮，与原“寻找起点”并列。
*   对按钮进行语义化重命名，取代晦涩的“智能匹配”术语，采用更直观的“寻找起点/终点”描述。
*   完善中英文多语言支持，确保在不同语言环境下显示准确。

## 2. 稳定性修复与系统健壮性提升

### 2.1 修复自动切歌 UI 假死问题 (Ghost Pause)
*   **现象**: 在长时间挂机播放或频繁切歌时，偶发界面显示为暂停状态（播放按钮显示 Play，进度条停滞），但后台音频仍在正常播放。
*   **原因分析**: 多线程竞态问题。旧轨道的 `PlaybackStopped` 事件与新轨道的 `PlaybackStarted` 事件触发时序由于线程调度原因发生错乱，导致 UI 错误地响应了旧轨道的停止信号。
*   **解决方案**:
    *   在 `AudioLooper` 中引入 `_isLoading` 原子标志位。
    *   在 `LoadAudio` 开始时置位，在 `finally` 块中复位。
    *   在 `PlaybackStopped` 事件回调中检查该标志，若处于加载状态则拦截停止信号，防止干扰 UI 状态机。

### 2.2 歌单系统去重与逻辑修正
*   **数据库层**: 在 `DatabaseHelper.AddSongToPlaylist` 方法中增加预检查逻辑 (`COUNT(1)`)，从底层杜绝同一首歌被多次添加到同一歌单。
*   **服务层**: 修正 `PlayerService.LoadTrack` 中的索引同步逻辑。当加载当前正在播放的曲目时，不再强制重置 `CurrentIndex`，解决了播放列表包含重复曲目时索引跳转异常的问题。

## 3. 结论
本次更新显著提升了软件在复杂场景下的适用性（OST 支持）以及长时间运行的稳定性。系统健壮性得到加强，消除了多个潜在的崩溃或状态不一致风险。
