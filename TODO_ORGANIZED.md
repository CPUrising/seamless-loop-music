# 无缝循环音乐播放器 - 开发路线图 & 任务清单

> **注**: 本文件是对 `todo.md` 中原始笔记的整理与分类。

## 1. 🚨 严重问题 (Bug 与 稳定性)

### **稳定性与性能**

- [X] **崩溃诊断/解决**: 引入全局异常捕获与初始化序列优化，减少了闪退。
- [X] **启动可靠性**: 修复了因 UI 刷新早于服务实例化导致的 `NullReferenceException`。
- [X] **线程安全**: 通过 PlayerService 串行化数据库访问与音频流控制。
- [X] **单例模式**: 已在 `App.xaml.cs` 中实现 Mutex 互斥体，禁止多开。
  - *现状*: 已完成。

### **音频瑕疵**

- [ ] **消除爆音**: 跳转或循环时的爆裂声在某些采样率下依然存在，需进一步优化。
  - *出现场景*: 切换歌曲时，有时在智能匹配时也会出现。

## 2. 🧠 核心算法 & 音频引擎

### **匹配逻辑改进**

- [X] **反向搜索优化**: 实现了基于 SAD 的指纹匹配算法 (`FindBestLoopPoints`)。
- [ ] **结尾处理**: 判断歌曲是否自然结束（无需循环）或需要淡出。
- [ ] **人声检测**: 排除人声部分的循环点候选。
- [X] **AB 循环支持**: 实现了 "前奏 (Intro) + 循环段 (Loop)" 的物理结构 (`LoopStream.cs`)。

### **高级研究 (FFT / 指纹识别)**

*目标: 批量处理与“整曲指纹识别”。*

- [ ] **算法研究**:
  - **FFT 互相关**: $O(N \log N)$ - 适合长片段匹配。
  - **金字塔搜索**: $O(N)$ - 快速由粗到细搜索。
  - **过零点检测**: 已在某些初步尝试中使用。
- [ ] **外部工具整合**:
  - 考虑使用 `Generic PyMusicLooper` 作为后端/处理器？
  - 读取其输出文件，同时允许 UI 手动微调。

### **格式支持**

- [X] **多格式支持**: 深度整合了 **WAV**、**MP3**、**OGG** 格式的原生读取。

## 3. ✨ 特性与功能

### **播放体验**

- [ ] **智能暂停**: 设备变更（如拔耳机）时自动暂停。
- [ ] **"全部播放" 模式**:
  - 循环播放所有歌曲？
  - 淡入淡出衔接 (循环末尾 -> 下一首开头+3s？)。
- [X] **列表导航**:
  - 点击切歌时，列表自动高亮并跟随滚动。
- [ ] **随机播放 (Shuffle)**: 待实现。
- [X] **文件夹管理**:
  - 支持将文件夹作为歌单添加。
  - 导出/保存歌单列表配置。
- [ ] 歌单：导入多个文件夹，导入外部歌单

### **UI / UX 改进**

- [X] **时间显示**: 实现了 `00:00 / 00:00` 的实时进度显示。
- [X] **音量控制**: 实现了全局音量滑块与静音逻辑。
- [X] **重命名界面**: 实现了基于数据库的 **别名 (Alias) 系统**。
- [ ] **文本选择**: 启用 Label/TextBlock 的 `IsTextSelectionEnabled="True"`。
- [ ] **列表刷新**: 考虑使用 `ObservableCollection` 优化现有列表刷新逻辑。

## 4. 🌍 本地化 (i18n)

- [X] **移除硬编码**: 大部分 UI 文本已迁移至底层资源文件。
- [X] **实现资源文件**:
  - 已建立 `.resx` 标准资源体系。
  - 支持 **简体中文** 与 **英文**。
- [ ] **多语言扩展**: 繁体中文、日语等尚未翻译。

## 5. 💾 配置与数据

- [X] **配置整合**: 配置文件已分类存储（settings.conf, playlists.conf）。
- [X] **音量记忆**: 音量设置已持久化保存。
- [X] **数据库升级**:
  - **已完成**: 由 CSV 迁移至 **SQLite** (`LoopData.db`)，实现指纹识别。

## 6. 📥 重构与技术债

- [X] **架构解耦**: 引入 `PlayerService` 层，分离 UI 与业务逻辑（v3.0 完成）。
- [X] **发布管理**: 整理了 `progress/` 目录与发布流程文档。

---

*由 Lev Zenith 根据最新进展动态更新。*
